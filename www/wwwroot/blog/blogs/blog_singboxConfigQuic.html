  
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通过 Quic和Hysteria2等udp协议实现代理 （没有实验）</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1, h2, h3 {
            color: #333;
        }
        code, pre {
            background-color: #1e1e1e;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 5px;
            font-family: Consolas, monospace;
        }
        pre {
            overflow-x: auto;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
     <h1>QUIC 协议介绍</h1>
    <div class="section">
        <h2>什么是 QUIC？</h2>
        <p><strong>QUIC</strong>（Quick UDP Internet Connections）是由谷歌开发的新一代传输协议，旨在提高网络通信的性能和安全性。它基于 UDP（用户数据报协议），结合了 TCP 和 TLS 的优点，解决了传统 HTTP/2 和 TCP 协议在延迟、连接建立和数据传输效率上的瓶颈问题。以下是 QUIC 的主要特点和优势：</p>
        <ul>
            <li><strong>低延迟连接</strong>：QUIC 将 TLS 加密与传输层握手整合，减少了建立连接所需的往返时间（RTT）。传统 TCP+TLS 需要多次握手，而 QUIC 通常只需 1-RTT 或 0-RTT（对于已知服务器）即可完成连接。</li>
            <li><strong>基于 UDP</strong>：QUIC 使用 UDP 作为底层协议，避免了 TCP 的队头阻塞（Head-of-Line Blocking）。这使得数据流可以独立传输，即使某个数据包丢失，也不会影响其他数据流。</li>
            <li><strong>内置加密</strong>：QUIC 默认集成 TLS 1.3，加密是协议的核心部分，所有数据传输都经过加密，增强了安全性。</li>
            <li><strong>多路复用</strong>：QUIC 支持多路复用，允许多个数据流同时传输，且不会因某个数据流的阻塞而影响其他流，解决了 HTTP/2 在 TCP 上的队头阻塞问题。</li>
            <li><strong>连接迁移</strong>：QUIC 使用连接 ID 标识连接，而非传统 IP 地址和端口。这意味着即使客户端网络环境变化（如从 Wi-Fi 切换到移动数据），连接也能保持不中断。</li>
            <li><strong>拥塞控制改进</strong>：QUIC 实现了更灵活的拥塞控制机制，能更快适应网络条件变化，提升传输效率。</li>
            <li><strong>HTTP/3 的基础</strong>：QUIC 是 HTTP/3 的底层传输协议，取代了 HTTP/2 的 TCP+TLS 组合，广泛用于现代 Web 应用以提升加载速度。</li>
        </ul>
        <h3>QUIC 的应用场景</h3>
        <ul>
            <li><strong>Web 浏览</strong>：QUIC 被广泛用于加速网页加载，谷歌的许多服务（如 YouTube、Google Search）已默认启用 QUIC。</li>
            <li><strong>实时应用</strong>：如视频会议、游戏等对延迟敏感的应用。</li>
            <li><strong>移动网络</strong>：QUIC 的连接迁移特性特别适合移动设备在不同网络间切换的场景。</li>
        </ul>
        <h3>QUIC 与 TCP 的对比</h3>
        <table>
            <tr>
                <th>特性</th>
                <th>QUIC</th>
                <th>TCP+TLS</th>
            </tr>
            <tr>
                <td>协议基础</td>
                <td>UDP</td>
                <td>TCP</td>
            </tr>
            <tr>
                <td>连接建立时间</td>
                <td>0-RTT 或 1-RTT</td>
                <td>2-3 RTT</td>
            </tr>
            <tr>
                <td>队头阻塞</td>
                <td>无（多路复用）</td>
                <td>有（单流阻塞影响全部）</td>
            </tr>
            <tr>
                <td>加密</td>
                <td>内置 TLS 1.3</td>
                <td>需额外 TLS 层</td>
            </tr>
            <tr>
                <td>连接迁移</td>
                <td>支持</td>
                <td>不支持</td>
            </tr>
        </table>
        <h3>当前状态</h3>
        <p>QUIC 已由 IETF 标准化（RFC 9000），并被广泛采纳。许多主流浏览器（如 Chrome、Firefox、Safari）和服务器（如 Cloudflare、Akamai）都支持 QUIC 和 HTTP/3。</p>
    </div>

    <h1>通过 Quic和Hysteria2等udp协议实现代理</h1>
    <p>本文介绍ECH，QUIC的一些概念</p>

    <h2>目标</h2>
     <ul>
        <li>使用 Nginx 限制 SSL 握手，仅允许特定 SNI（如 <code><YOUR_DOMAIN></code>）。</li>
        <li>伪装流量为 <code>cloudflare.com</code>，类似 Sing-box 的 <code>masquerade</code>。</li>
        <li>启用 Cloudflare 的 QUIC（HTTP/3）和 ECH，隐藏真实 SNI（如 <code><YOUR_DOMAIN></code>）为 <code>cloudflare-ech.com</code>。</li>
        <li>在 Shadowrocket（iOS 客户端）配置 Hysteria2、TUIC 和 ShadowTLS，支持 QUIC 和 ECH。</li>
        <li>模拟通配符 SNI 匹配（如 <code>*.yourdomain.com</code>），提高灵活性。</li>
        <li>处理 ShadowTLS 的 GFW 阻断问题，提供备用方案。</li>
    </ul>

    <h2>环境说明</h2>
    <ul>
        <li><strong>服务端</strong>：Sing-box 运行 Hysteria2（端口 443，密码 <code><YOUR_PASSWORD></code>）、TUIC（端口 8443，UUID <code><YOUR_UUID></code>，密码 <code><YOUR_PASSWORD></code>）和 ShadowTLS（端口 443，伪装 SNI <code>cloudflare.com</code>），证书为 <code>/etc/nginx/certs/proxy.yourdomain.com.pem</code>。</li>
        <li><strong>客户端</strong>：Shadowrocket（iOS），支持 Hysteria2、TUIC 和 ShadowTLS。</li>
        <li><strong>Cloudflare</strong>：启用 QUIC 和 ECH，DNS 代理隐藏服务器 IP。</li>
       </ul>

 

    <h2>1. Cloudflare 配置</h2>
    <h3>启用 QUIC（HTTP/3）</h3>
    <p>QUIC 使用 UDP 传输，适合 Hysteria2 和 TUIC，降低 GFW TCP 阻断风险。</p>
    <ol>
        <li>登录 <a href="https://dash.cloudflare.com">Cloudflare 仪表板</a>，选择您的域名（<code><YOUR_DOMAIN></code>）。</li>
        <li>导航至 <strong>Speed > Optimization</strong>，启用 <strong>HTTP/3 (with QUIC)</strong>。</li>
        <li>若仪表板无效，使用 API：
            <pre><code>curl -X PATCH "https://api.cloudflare.com/client/v4/zones/<ZONE_ID>/settings/http3" \
-H "Authorization: Bearer <API_TOKEN>" \
-H "Content-Type: application/json" \
--data '{"value": "on"}'</code></pre>
        </li>
        <li>验证 QUIC：
            <pre><code>curl --http3 https://<YOUR_DOMAIN> -v</code></pre>
            检查 <code>alt-svc: h3=":443"</code>。
        </li>
    </ol>

    <h3>启用 ECH</h3>
    <p>ECH 隐藏真实 SNI（如 <code><YOUR_DOMAIN></code>），使用 <code>cloudflare-ech.com</code> 替代，降低 GFW 过滤风险。</p>
    <ol>
        <li>免费计划默认启用 ECH。若仪表板无 <strong>SSL/TLS > Edge Certificates > ECH</strong>，使用 API：
            <pre><code>curl -X PATCH "https://api.cloudflare.com/client/v4/zones/<ZONE_ID>/settings/encrypted_client_hello" \
-H "Authorization: Bearer <API_TOKEN>" \
-H "Content-Type: application/json" \
--data '{"value": "on"}'</code></pre>
        </li>
        <li>验证 ECH：
            <pre><code>dig +short <YOUR_DOMAIN> HTTPS</code></pre>
            检查 <code>echconfig=<base64-encoded-key></code>。
        </li>
        <li>确保 DNS 记录为 <strong>Proxied</strong>（橙色云图标）。</li>
    </ol>

 
    <h2>3. Sing-box 配置</h2>
    <p>Sing-box 运行 Hysteria2、TUIC 和 ShadowTLS，依赖 Cloudflare 的 ECH，监听本地接口。</p>
    <pre><code># /etc/sing-box/config.json
{
  "log": {
    "level": "trace"
  },
  "inbounds": [
    {
      "type": "hysteria2",
      "listen": "127.0.0.1",
      "listen_port": 443,
      "users": [
        {
          "password": "<YOUR_PASSWORD>",
          "name": "singbox@hysteria2"
        }
      ],
      "up_mbps": 100,
      "down_mbps": 50,
      "ignore_client_bandwidth": false,
      "tls": {
        "enabled": true,
        "server_name": "<YOUR_DOMAIN>",
        "alpn": ["h3"],
        "certificate_path": "/etc/nginx/certs/proxy.yourdomain.com.pem",
        "key_path": "/etc/nginx/certs/proxy.yourdomain.com.key"
      },
      "masquerade": "https://cloudflare.com",
      "brutal_debug": false
    },
    {
      "type": "tuic",
      "tag": "singbox-tuic-in",
      "listen": "127.0.0.1",
      "listen_port": 8443,
      "users": [
        {
          "uuid": "<YOUR_UUID>",
          "password": "<YOUR_PASSWORD>",
          "name": "yourdomain_tuic"
        }
      ],
      "congestion_control": "bbr",
      "auth_timeout": "5s",
      "zero_rtt_handshake": false,
      "heartbeat": "10s",
      "tls": {
        "enabled": true,
        "server_name": "<YOUR_DOMAIN>",
        "certificate_path": "/etc/nginx/certs/proxy.yourdomain.com.pem",
        "key_path": "/etc/nginx/certs/proxy.yourdomain.com.key"
      }
    }
  
  ]
}
</code></pre>
    <h3>说明</h3>
    <ul>
        <li><strong>QUIC</strong>：Hysteria2 和 TUIC 默认使用 UDP，支持 QUIC。</li>
        <li><strong>ECH</strong>：依赖 Cloudflare，移除 Sing-box 的 ECH 配置。</li>
        <li><strong>伪装</strong>：Hysteria2 和 ShadowTLS 使用 <code>cloudflare.com</code> 伪装。</li>
      </ul>

    <h2>5. Shadowrocket 客户端配置</h2>
    <p>Shadowrocket 配置 Hysteria2、TUIC 和 ShadowTLS，使用 Cloudflare 的 ECH（SNI 为 <code>cloudflare-ech.com</code>）。</p>
    <h3>Hysteria2</h3>
    <ul>
        <li><strong>类型</strong>：Hysteria2</li>
        <li><strong>服务器</strong>：<YOUR_DOMAIN></li>
        <li><strong>端口</strong>：443</li>
        <li><strong>密码</strong>：<YOUR_PASSWORD></li>
        <li><strong>SNI</strong>：cloudflare-ech.com</li>
        <li><strong>ALPN</strong>：h3</li>
        <li><strong>跳过证书验证</strong>：禁用</li>
        <li><strong>上行/下行带宽</strong>：100 / 50</li>
        <li><strong>URL</strong>：
            <pre><code>hysteria2://<YOUR_PASSWORD>@<YOUR_DOMAIN>:443/?sni=cloudflare-ech.com&alpn=h3&upmbps=100&downmbps=50</code></pre>
        </li>
    </ul>

    <h3>TUIC</h3>
    <ul>
        <li><strong>类型</strong>：TUIC</li>
        <li><strong>服务器</strong>：<YOUR_DOMAIN></li>
        <li><strong>端口</strong>：8443</li>
        <li><strong>UUID</strong>：<YOUR_UUID></li>
        <li><strong>密码</strong>：<YOUR_PASSWORD></li>
        <li><strong>SNI</strong>：cloudflare-ech.com</li>
        <li><strong>拥塞控制</strong>：BBR</li>
        <li><strong>认证超时</strong>：5s</li>
        <li><strong>0-RTT 握手</strong>：禁用</li>
        <li><strong>心跳间隔</strong>：10s</li>
        <li><strong>跳过证书验证</strong>：禁用</li>
        <li><strong>URL</strong>：
            <pre><code>tuic://<YOUR_UUID>:<YOUR_PASSWORD>@<YOUR_DOMAIN>:8443/?sni=cloudflare-ech.com&congestion_control=bbr&auth_timeout=5s&zero_rtt=false&heartbeat=10s</code></pre>
        </li>
    </ul>


    <h3>DoH 配置</h3>
    <p>防止 DNS 泄露：
    <ul>
        <li>打开 Shadowrocket <strong>设置 > DNS</strong>。</li>
        <li>启用 <strong>DNS over HTTPS</strong>，设置为 <code>https://1.1.1.1/dns-query</code>。</li>
    </ul>

    <h2>6. GFW 抗审查优化</h2>
    <ul>
        <li><strong>Nginx SNI 限制</strong>：模拟 <code>*.yourdomain.com</code>，拒绝非法 SNI（如 GFW 探测）。</li>
        <li><strong>Cloudflare ECH</strong>：隐藏 <code><YOUR_DOMAIN></code> 为 <code>cloudflare-ech.com</code>（Hysteria2/TUIC）。</li>
        <li><strong>QUIC</strong>：Hysteria2 和 TUIC 使用 UDP，降低 TCP 阻断风险。</li>
    
        <li><strong>IP 隐藏</strong>：Cloudflare 代理避免 IP 暴露。</li>
        <li><strong>备用方案</strong>：若 <code>cloudflare-ech.com</code> 或 <code>cloudflare.com</code> 被封，切换 SNI（如 <code>dns.google</code>）或协议（如 VLESS）。</li>
    </ul>

    <h2>7. 验证与故障排查</h2>
    <h3>Nginx</h3>
    <pre><code>nginx -t
systemctl restart nginx
tail -f /var/log/nginx/error.log</code></pre>

    <h3>Cloudflare</h3>
    <ul>
        <li>QUIC：<pre><code>curl --http3 https://<YOUR_DOMAIN> -v</code></pre></li>
        <li>ECH：<pre><code>dig +short <YOUR_DOMAIN> HTTPS</code></pre></li>
    </ul>

    <h3>Sing-box</h3>
    <pre><code>netstat -lupn | grep -E '443|8443'
journalctl -u sing-box -f</code></pre>

    <h3>Shadowrocket</h3>
    <ul>
        <li>测试访问 <code>google.com</code>。</li>
        <li>检查日志，确保 SNI 为 <code>cloudflare-ech.com</code>（Hysteria2/TUIC）或 <code>cloudflare.com</code>（ShadowTLS）。</li>
    </ul>

   

    <h3>GFW 测试</h3>
    <p>使用 <a href="https://www.greatfirewallofchina.org">greatfirewallofchina.org</a> 测试 <code><YOUR_DOMAIN></code>、<code>cloudflare-ech.com</code> 和 <code>cloudflare.com</code>。</p>

    <h2>总结</h2>
    <p>通过Cloudflare 的 QUIC 和 ECH、Sing-box 的 Hysteria2、TUIC  协议，以及 Shadowrocket 的客户端配置，您可以搭建一个抗 GFW 的代理服务。关键点包括：</p>
    <ul>
     
        <li>Cloudflare 代理隐藏 IP，ECH 隐藏 SNI，QUIC 优化性能。</li>
      
        <li>定期监控 <code>cloudflare-ech.com</code> 和 <code>cloudflare.com</code>，准备备用 SNI 或协议。</li>
    </ul>
  

</body>
</html>