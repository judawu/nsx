<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用 Nginx 转发 VLESS 协议流量</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>使用 Nginx 转发 VLESS 协议流量</h1>
    <p>本文将详细介绍如何配置 Nginx 将外部访问 <code>p1.mydomain:443</code> 的流量转发到本地 VLESS 服务的 <code>61111</code> 端口。VLESS 是一种轻量级代理协议，通常与 V2Ray 或 Xray 核心配合使用，支持 WebSocket 或 TCP 传输。本文涵盖两种常见场景的配置方法：WebSocket 和纯 TCP 传输。</p>

    <h2>前提条件</h2>
    <ul>
        <li>Nginx 已安装，并启用 <code>stream</code> 模块（用于 TCP 转发）。可通过以下命令检查：
            <pre><code>nginx -V 2>&1 | grep stream</code></pre>
        </li>
        <li>VLESS 服务（如 V2Ray/Xray）已配置并监听在 <code>127.0.0.1:61111</code>。</li>
        <li>为 <code>p1.mydomain</code> 配置了有效的 SSL 证书（可通过 Let’s Encrypt 获取）。</li>
        <li>域名 <code>p1.mydomain</code> 已解析到服务器 IP。</li>
    </ul>

    <h2>场景 1：VLESS 使用 WebSocket 传输</h2>
    <p>如果 VLESS 配置为通过 WebSocket 传输（常用于伪装 HTTPS 流量），Nginx 可以作为 WebSocket 反向代理。以下是配置步骤：</p>

    <h3>1. 配置 Nginx</h3>
    <p>编辑 Nginx 配置文件（例如 <code>/etc/nginx/conf.d/p1_mydomain.conf</code>）：</p>
    <pre><code>server {
    listen 443 ssl;
    server_name p1.mydomain;

    # SSL 证书配置
    ssl_certificate /path/to/your/p1.mydomain.crt;
    ssl_certificate_key /path/to/your/p1.mydomain.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location /vless { # 替换为 VLESS 配置的 WebSocket 路径
        proxy_pass http://127.0.0.1:61111;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
    </code></pre>
    <p><strong>说明</strong>：</p>
    <ul>
        <li><code>location /vless</code>：对应 VLESS 的 WebSocket 路径，客户端访问 <code>wss://p1.mydomain/vless</code>。</li>
        <li><code>proxy_http_version 1.1</code> 和 <code>Upgrade/Connection</code>：启用 WebSocket 支持。</li>
        <li><code>proxy_pass</code>：将流量转发到本地 61111 端口。</li>
    </ul>

    <h3>2. 配置 VLESS 服务端</h3>
    <p>确保 V2Ray/Xray 的 VLESS 配置启用了 WebSocket，并与 Nginx 的路径一致。例如：</p>
    <pre><code>{
    "inbounds": [
        {
            "port": 61111,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "id": "your-uuid-here"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "ws",
                "wsSettings": {
                    "path": "/vless"
                }
            }
        }
    ]
}
    </code></pre>

    <h3>3. 测试和重启</h3>
    <ul>
        <li>检查配置：<code>sudo nginx -t</code></li>
        <li>重启 Nginx：<code>sudo systemctl restart nginx</code></li>
        <li>使用 VLESS 客户端连接 <code>wss://p1.mydomain/vless</code>，验证是否正常。</li>
    </ul>

    <h2>场景 2：VLESS 使用纯 TCP 传输</h2>
    <p>如果 VLESS 使用纯 TCP 传输，需使用 Nginx 的 <code>stream</code> 模块进行转发。以下是配置步骤：</p>

    <h3>1. 配置 Nginx</h3>
    <p>编辑 <code>/etc/nginx/nginx.conf</code> 或新建 <code>/etc/nginx/conf.d/vless_stream.conf</code>：</p>
    <pre><code>stream {
    server {
        listen 443 ssl;
        server_name p1.mydomain;

        # SSL 证书配置
        ssl_certificate /path/to/your/p1.mydomain.crt;
        ssl_certificate_key /path/to/your/p1.mydomain.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # 转发到 VLESS 服务
        proxy_pass 127.0.0.1:61111;
    }
}
    </code></pre>
    <p><strong>说明</strong>：</p>
    <ul>
        <li><code>stream</code> 块：处理 TCP/UDP 流量。</li>
        <li><code>listen 443 ssl</code>：监听 443 端口并启用 SSL。</li>
        <li><code>proxy_pass</code>：将解密后的 TCP 流量转发到 61111 端口。</li>
    </ul>

    <h3>2. 配置 VLESS 服务端</h3>
    <p>确保 VLESS 配置使用 TCP 传输，且不启用 TLS（Nginx 已处理 TLS）。例如：</p>
    <pre><code>{
    "inbounds": [
        {
            "port": 61111,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "id": "your-uuid-here"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp"
            }
        }
    ]
}
    </code></pre>

    <h3>3. 测试和重启</h3>
    <ul>
        <li>检查配置：<code>sudo nginx -t</code></li>
        <li>重启 Nginx：<code>sudo systemctl restart nginx</code></li>
        <li>使用 VLESS 客户端连接 <code>vless://uuid@p1.mydomain:443</code>，验证是否正常。</li>
    </ul>

    <h2>常见问题及解决方法</h2>
    <ol>
        <li><strong>Stream 模块未启用</strong>：若 Nginx 不支持 <code>stream</code> 模块，需安装 <code>nginx-extras</code>（Debian/Ubuntu）或 <code>nginx-module-stream</code>（CentOS/RHEL）。</li>
        <li><strong>连接失败</strong>：
            <ul>
                <li>检查 Nginx 日志：<code>/var/log/nginx/error.log</code> 和 <code>access.log</code>。</li>
                <li>确认 VLESS 服务监听 61111 端口：<code>sudo netstat -tuln | grep 61111</code>。</li>
                <li>确保防火墙允许 443 端口：<code>sudo ufw allow 443</code>。</li>
            </ul>
        </li>
        <li><strong>SSL 证书问题</strong>：使用 Let’s Encrypt 获取证书：<code>sudo apt install certbot python3-certbot-nginx</code>。</li>
    </ol>

    <h2>扩展配置</h2>
    <ul>
        <li><strong>访问控制</strong>：限制 IP 访问：
            <pre><code>allow 192.168.1.0/24;
deny all;
            </code></pre>
        </li>
        <li><strong>日志记录</strong>：启用详细日志：
            <pre><code>access_log /var/log/nginx/vless_access.log;
error_log /var/log/nginx/vless_error.log;
            </code></pre>
        </li>
        <li><strong>性能优化</strong>：调整并发连接：
            <pre><code>worker_processes auto;
events {
    worker_connections 1024;
}
            </code></pre>
        </li>
    </ul>

    <h2>总结</h2>
    <p>通过 Nginx 转发 VLESS 流量，可以实现安全、高效的代理服务。对于 WebSocket 传输，使用 HTTP 模块配置；对于 TCP 传输，使用 <code>stream</code> 模块。确保 SSL 证书、域名解析和 VLESS 配置正确，结合日志调试，可快速搭建稳定服务。如需进一步优化或排查，请提供具体配置或错误详情！</p>
</body>
</html>